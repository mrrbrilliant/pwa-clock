let t=null;self.addEventListener("message",i=>{const e=i.data;if(console.log("SW received message:",e),e.type==="SET_ALARM"&&e.timestamp){t&&(clearTimeout(t),t=null);const o=e.timestamp,l=o-Date.now();console.log("Setting alarm for:",new Date(o).toLocaleString()),console.log("Time until alarm:",Math.floor(l/1e3),"seconds"),l>0&&(t=setTimeout(async()=>{console.log("ALARM TIME!");const n=await self.clients.matchAll({type:"window"});for(const a of n)a.postMessage({type:"ALARM_TRIGGERED"});await self.registration.showNotification("Alarm!",{body:"Your alarm is ringing!",icon:"/icons/icon-192x192.png",tag:"alarm",requireInteraction:!0})},l))}e.type==="CLEAR_ALARM"&&t&&(clearTimeout(t),t=null)});self.addEventListener("install",()=>{console.log("Service Worker installing"),self.skipWaiting()});self.addEventListener("activate",i=>{console.log("Service Worker activating"),i.waitUntil(self.clients.claim())});self.addEventListener("notificationclick",i=>{console.log("Notification clicked"),i.notification.close(),i.waitUntil(self.clients.matchAll({type:"window"}).then(e=>{e.length>0?e[0].focus():self.clients.openWindow("/")}))});
